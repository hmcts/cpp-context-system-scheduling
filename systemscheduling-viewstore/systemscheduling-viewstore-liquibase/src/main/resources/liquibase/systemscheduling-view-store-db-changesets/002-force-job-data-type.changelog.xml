<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.3.xsd">

    <changeSet id="2.1" author="tomaszp">

        <preConditions onFail="MARK_RAN"
                       onFailMessage="Change set skipped because data type is already correct. Change set needed when database schema is recreated from scratch (liquibase 3.5.2 changed mapping for type BLOB from bytea to oid, but quartz required it to be bytea)">
            <sqlCheck expectedResult="oid">select data_type from information_schema.columns where
                table_name = 'qrtz_job_details' and column_name='job_data';
            </sqlCheck>
        </preConditions>

        <dropColumn tableName="QRTZ_JOB_DETAILS" columnName="JOB_DATA"/>

        <addColumn tableName="QRTZ_JOB_DETAILS">
            <column name="JOB_DATA" type="BINARY"/>
        </addColumn>
    </changeSet>

    <changeSet id="2.2" author="tomaszp">

        <preConditions onFail="MARK_RAN"
                       onFailMessage="Change set skipped because data type is already correct. Change set needed when database schema is recreated from scratch (liquibase 3.5.2 changed mapping for type BLOB from bytea to oid, but quartz required it to be bytea)">
            <sqlCheck expectedResult="oid">select data_type from information_schema.columns where
                table_name = 'qrtz_blob_triggers' and column_name='job_data';
            </sqlCheck>
        </preConditions>

        <dropColumn tableName="QRTZ_BLOB_TRIGGERS" columnName="JOB_DATA"/>

        <addColumn tableName="QRTZ_BLOB_TRIGGERS">
            <column name="JOB_DATA" type="BINARY"/>
        </addColumn>
    </changeSet>

    <changeSet id="2.3" author="tomaszp">

        <preConditions onFail="MARK_RAN"
                       onFailMessage="Change set skipped because data type is already correct. Change set needed when database schema is recreated from scratch (liquibase 3.5.2 changed mapping for type BLOB from bytea to oid, but quartz required it to be bytea)">
            <sqlCheck expectedResult="oid">select data_type from information_schema.columns where
                table_name = 'qrtz_triggers' and column_name='job_data';
            </sqlCheck>
        </preConditions>

        <dropColumn tableName="QRTZ_TRIGGERS" columnName="JOB_DATA"/>

        <addColumn tableName="QRTZ_TRIGGERS">
            <column name="JOB_DATA" type="BINARY"/>
        </addColumn>
    </changeSet>

</databaseChangeLog>
